<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <link href="css/myProfileStyle.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

    <style>
        .alert-success {
            color: white;
            background-color: #f0f9eb;
            padding: 1px;
            margin-bottom: 20px;
            border-radius: 8px;
            /*display: flex;*/
            /*align-items: center;*/
        }

        .alert-success i {
            margin-right: 8px;
        }

    </style>
</head>
<th:block layout:fragment="content">

    <body>
    <div class="blur-background"></div>

    <div class="forgot-password-wrapper mt-md-0 mt-sm-0 mt-lg-5">

        <div class="container-myProfile mt-lg-5">
            <h2>My Profile</h2>
            <div class="tabs">
                <button class="tablink active" onclick="openTab(event, 'PersonalInfo')" id="defaultOpen">Personal
                    Information
                </button>
                <button class="tablink" onclick="openTab(event, 'Security')">Change Password</button>
            </div>

            <div id="PersonalInfo" class="tabcontent active">
                <form th:action="@{/save}" method="post" th:object="${userInfo}">
                    <div class="alert-success" th:if="${successfully}">
                        <p style="color: #67c23a">
                            <i class="bi bi-check-circle"></i>
                            <span  th:text="${successfully}"></span>
                        </p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fullname">Full Name:</label>
                            <input type="text" id="fullname" name="fullname" th:field="*{fullName}" th:value="${userInfo.fullName}" required>
                        </div>
                        <div class="form-group">
                            <label for="dob">Date of Birth:</label>
                            <input type="date" id="dob" name="dob" th:field="*{dob}" th:value="${userInfo.dob}">


                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number:</label>
                            <input type="tel" id="phone" name="phone" required th:field="*{phone}" th:value="${userInfo.phone}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email Address:</label>
                            <input type="email" id="email" name="email" required th:field="*{email}" th:value="${userInfo.email}" readonly>
                        </div>

                        <div class="form-group">
                            <label for="nationalID">National ID No.:</label>
                            <input type="text" id="nationalID" name="nationalID" required th:field="*{nationalId}" th:value="${userInfo.nationalId}" >
                        </div>
                        <div class="form-group">
                            <label for="drivingLicense">Driving License:</label>
                            <input type="text" id="drivingLicense" name="drivingLicense" th:field="*{drivingLicense}" th:value="${userInfo.drivingLicense}" required>
                        </div>
                    </div>

                    <div class="address-row">
                        <select id="city" name="provinceId" th:field="*{city}" th:value="${userInfo.city}" th:data-default="${userInfo.city}" >
                            <option value="">Select Province</option>
                        </select>

                        <select id="district" name="districtId" th:field="*{district}" th:value="${userInfo.district}" th:data-default="${userInfo.district}">
                            <option value="">Select District</option>
                        </select>

                        <select id="ward" name="wardId" th:field="*{ward}" th:value="${userInfo.ward}" th:data-default="${userInfo.ward}">
                            <option value="">Select Ward</option>
                        </select>

                        <input type="text" id="street" th:field="*{street}" th:value="${userInfo.street}" required>
                    </div>


                    <div class="buttons">
                        <button type="submit">Save</button>
                        <button type="button" href="">Discard</button>
                    </div>
                </form>
            </div>

            <div id="Security" class="tabcontent">
                <form method="post" th:action="@{/my-profile}" th:object="${myProfileDto}">
<!--                    Hiển thị thành công-->
                    <div class="alert-success" th:if="${success}">
                        <p style="color: #67c23a">
                            <i class="bi bi-check-circle"></i>
                            <span  th:text="${success}"></span>
                        </p>
                    </div>


                    <div th:if="${error}" >
                        <p style="color: red;" th:text="${error}"></p>
                    </div>


                    <label for="oldPassword">Old Password:</label>
                    <input type="password" id="oldPassword" name="oldPassword" th:field="*{oldPassword}" required>

                    <div th:if="${#fields.hasErrors('oldPassword')}" th:errors="*{oldPassword}"
                         style="color: red"></div>

                    <label for="newPassword">New Password:</label>
                    <input type="password" id="newPassword" name="newPassword" th:field="*{newPassword}" required>

                    <div th:if="${#fields.hasErrors('newPassword')}" th:errors="*{newPassword}"
                         style="color: red"></div>

                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" th:field="*{confirmPassword}" required>

                    <div th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"
                         style="color: red"></div>

                    <div class="buttons">
                        <button type="submit">Save</button>
                        <button type="reset">Discard</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- JS -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;

            // Hide all tab content
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Remove the active class from all tab links
            tablinks = document.getElementsByClassName("tablink");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an active class to the button that opened the tab
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Function to open the default tab on page load
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("defaultOpen").click();
        });



        // Fetch provinces and set default city
        async function fetchProvinces(defaultCity) {
            const response = await fetch('https://provinces.open-api.vn/api/p/');
            const provinces = await response.json();
            const citySelect = document.getElementById('city');

            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province.code;
                option.textContent = province.name;
                if (province.code == defaultCity) {
                    option.selected = true;
                }
                citySelect.appendChild(option);
            });

            if (defaultCity) {
                fetchDistricts(defaultCity, document.getElementById('district').getAttribute('data-default'));
            }
        }

        // Fetch districts based on selected province and set default value
        async function fetchDistricts(provinceCode, defaultDistrict) {
            const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
            const provinceData = await response.json();
            const districtSelect = document.getElementById('district');

            districtSelect.innerHTML = '<option value="">Select District</option>';
            provinceData.districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district.code;
                option.textContent = district.name;
                if (district.code == defaultDistrict) {
                    option.selected = true;
                }
                districtSelect.appendChild(option);
            });

            if (defaultDistrict) {
                fetchWards(defaultDistrict, document.getElementById('ward').getAttribute('data-default'));
            }
        }

        // Fetch wards based on selected district and set default value
        async function fetchWards(districtCode, defaultWard) {
            const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
            const districtData = await response.json();
            const wardSelect = document.getElementById('ward');

            wardSelect.innerHTML = '<option value="">Select Ward</option>';
            districtData.wards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward.code;
                option.textContent = ward.name;
                if (ward.code == defaultWard) {
                    option.selected = true;
                }
                wardSelect.appendChild(option);
            });
        }

        // Event listeners to load data on selection
        document.getElementById('city').addEventListener('change', function () {
            fetchDistricts(this.value);
            document.getElementById('ward').innerHTML = '<option value="">Select Ward</option>'; // Reset ward
            document.getElementById('district').disabled = this.value === ""; // Enable/disable district based on city selection
            document.getElementById('district').value = ""; // Reset district value
            document.getElementById('ward').disabled = true; // Disable ward selection
        });

        document.getElementById('district').addEventListener('change', function () {
            fetchWards(this.value);
            document.getElementById('ward').disabled = this.value === ""; // Enable/disable ward based on district selection
        });

        // Check selections before submitting the form
        document.querySelector('form').addEventListener('submit', function(event) {
            const citySelect = document.getElementById('city');
            const districtSelect = document.getElementById('district');
            const wardSelect = document.getElementById('ward');

            if (!citySelect.value || !districtSelect.value || !wardSelect.value) {
                event.preventDefault(); // Ngăn không cho gửi form
                alert('Please select a valid Province, District, and Ward.'); // Hiển thị thông báo lỗi
            }
        });

        // Load provinces on page load with default values
        document.addEventListener('DOMContentLoaded', function () {
            const defaultCity = document.getElementById('city').getAttribute('data-default');
            fetchProvinces(defaultCity);
        });

    </script>
    </body>
</th:block>
</html>

