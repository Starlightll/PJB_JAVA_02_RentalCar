<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <title>My Wallet</title>
    <meta name="_csrf" th:content="${_csrf.token}">
    <link rel="stylesheet" href="/css/user/my-wallet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker3.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<th:block layout:fragment="content">
    <body>
    <section class="hero-wrap hero-wrap js-fullheight" data-stellar-background-ratio="0.5">
        <div class="overlay"></div>
        <div class="container">
            <div class="row no-gutters slider-text js-fullheight align-items-end justify-content-start">
                <div class="col-md-9 ftco-animate">
                    <p class="breadcrumbs">
                        <span class="mr-2"><a href="/">Home <i class="ion-ios-arrow-forward"></i></a></span>
                        <span>My Wallet</span>
                    </p>
                    <h1 class="mb-3 bread">My Wallet</h1>
                </div>
            </div>
        </div>
    </section>
    <section class="ftco-section" style="min-height: 400px">
        <div class="container" id="grad1">
            <div class="row">
                <div class="col-md-8">
                    <h4 class="font-weight-bold">Your current balance:</h4>
                    <h2 id="walletBalance" style="color: green;" th:text="${formattedWallet} + ' VND'"></h2>
                </div>
                <div class="col-md-4 d-flex justify-content-end align-items-center">
                    <button class="btn btn-warning mr-2 ">Withdraw</button>
                    <button class="btn btn-success  ">Top-up</button>
                </div>
            </div>

            <!-- Date Filters Row -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <h4 class="font-weight-bold">Transactions:</h4>
                </div>
                <div class="col-md-6">
                    <label>From</label>
                    <input type="text" class="form-control datepicker" id="fromDate" th:value="${fromDate}" placeholder="Select Start Date">
                </div>
                <div class="col-md-6">
                    <label>To</label>
                    <input type="text" class="form-control datepicker" id="toDate" th:value="${toDate}" placeholder="Select End Date">
                </div>
            </div>

            <!-- Search Button Row -->
            <div class="row mt-3">
                <div class="col-md-12 d-flex justify-content-end">
                    <button class="btn btn-primary" id="searchBtn">Search</button>
                </div>
            </div>

            <!-- Transaction History Table Row -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <table class="table table-bordered">
                        <thead class="thead-dark">
                        <tr>
                            <th>No</th>
                            <th>Amount</th>
                            <th>Type</th>
                            <th>Date Time</th>
                            <th>Booking No</th>
                            <th>Car Name</th>
                            <th>Note</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>1</td>
                            <td>+10,000,000 VND</td>
                            <td>Top-up</td>
                            <td>12/02/2022 18:00</td>
                            <td>12345678</td>
                            <td>Nissan Navara El 2017</td>
                            <td>N/A</td>
                        </tr>
                        <tr th:each="transaction, iterStat : ${transactions}">
                            <td th:text="${iterStat.index + 1}"></td>
                            <td th:text="${transaction.amount}"></td>
                            <td th:text="${transaction.transactionType}"></td>
                            <td th:text="${#dates.format(transaction.transactionDate, 'dd/MM/yyyy HH:mm')}"></td>
                            <td th:text="${transaction.booking != null ? transaction.booking.id : 'N/A'}"></td>
                            <td th:text="${transaction.booking != null ? transaction.booking.car.carName : 'N/A'}"></td>
                            <td th:text="${transaction.note}"></td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    <nav aria-label="Transaction history pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- Top-up Modal -->
    <div class="modal fade" id="topUpModal" tabindex="-1" role="dialog" aria-labelledby="topUpModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title font-weight-bold text-dark" id="topUpModalLabel">Top-up</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="text-dark">Please select the amount to top-up to your wallet</p>
                    <select class="form-control" id="topUpAmount">
                        <option value="2000000">2,000,000 VND</option>
                        <option value="5000000">5,000,000 VND</option>
                        <option value="10000000">10,000,000 VND</option>
                    </select>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="topUpConfirm">OK</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModal" tabindex="-1" role="dialog" aria-labelledby="withdrawModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title font-weight-bold text-dark" id="withdrawModalLabel">Withdraw</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="withdrawModalPara" class="text-dark">Your current balance is <span th:text="${formattedWallet}"></span>. Please select the amount to withdraw from your wallet</p>
                    <select class="form-control" id="withdrawAmount">
                        <option value="2000000">2,000,000 VND</option>
                        <option value="5000000">5,000,000 VND</option>
                        <option value="10000000">10,000,000 VND</option>
                        <option th:value="${user.getWallet()}">All balance</option>
                    </select>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="withdrawConfirm">OK</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Success -->
    <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">Success</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="successModalBody">
                    <p>Your transaction was successfully processed!</p>
                    <p><strong>Transaction Type:</strong> <span id="transactionType"></span></p>
                    <p><strong>Amount:</strong> <span id="transactionAmount"></span></p>
                    <p><strong>New Balance:</strong> <span id="newBalance"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Error -->
    <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="errorModalBody">
                    <p>Something went wrong. Please try again later.</p>
                    <p>If the issue persists, contact customer support.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>




    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            $('.datepicker').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true
            });
            $('#searchBtn').on('click', function () {
                const fromDate = $('#fromDate').val();
                const toDate = $('#toDate').val();
                const url = `/wallet/my-wallet?fromDate=${fromDate}&toDate=${toDate}`;
                window.location.href = url;
            });
        });

        $('.btn-success').on('click', function () {
            $('#topUpModal').modal('show');
        });

        $('.btn-warning').on('click', function () {
            $('#withdrawModal').modal('show');
        });
    </script>
    <script>
        $(document).ready(function () {
            checkWithdrawButton();

            $('#topUpConfirm').on('click', function () {
                var amount = $('#topUpAmount').val();
                $.ajax({
                    url: '/wallet/top-up',
                    method: 'POST',
                    data: {
                        amount: amount,
                        _csrf: $('meta[name="_csrf"]').attr('content')
                    },
                    success: function (response) {
                        console.log("Top-up successful", response);
                        $('#walletBalance').text(response.newBalance + ' VND');
                        $('#topUpModal').modal('hide');
                        Swal.fire({
                            title: 'Success!',
                            text: 'Your top-up of ' + amount + ' VND has been successful.',
                            icon: 'success',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'my-custom-button'
                            }
                        });
                        checkWithdrawButton();
                    },
                    error: function () {
                        Swal.fire({
                            title: 'Error!',
                            text: 'An error occurred while topping up your wallet. Please try again.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });

            $('#withdrawConfirm').on('click', function () {
                var amount = parseFloat($('#withdrawAmount').val());
                let currentBalance = parseFloat($('#walletBalance').text().replace(' VND', '').replaceAll(',', ''));

                if (amount > currentBalance) {
                    Swal.fire({
                        title: 'Error!',
                        text: 'Withdrawal amount cannot be greater than your current balance.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return false;
                }

                $.ajax({
                    url: '/wallet/withdraw',
                    method: 'POST',
                    data: {
                        amount: amount,
                        _csrf: $('meta[name="_csrf"]').attr('content')
                    },
                    success: function (response) {
                        console.log("Withdraw successful", response);
                        $('#walletBalance').text(response.newBalance + ' VND');
                        $('#withdrawModal').modal('hide');
                        Swal.fire({
                            title: 'Success!',
                            text: 'Your withdrawal of ' + amount + ' VND has been successful.',
                            icon: 'success',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'my-custom-button'
                            }
                        });
                        checkWithdrawButton();
                    },
                    error: function () {
                        Swal.fire({
                            title: 'Error!',
                            text: 'An error occurred while withdrawing from your wallet. Please try again.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });

            function checkWithdrawButton() {
                let currentBalance = $('#walletBalance').text().replace(' VND', '').replaceAll(',', '');

                if (parseFloat(currentBalance) === 0) {
                    $('.btn-warning').prop('disabled', true);
                } else {
                    $('.btn-warning').prop('disabled', false);
                }
            }

            $('.btn-warning').on('click', function () {
                let currentBalance = $('#walletBalance').text().replace(' VND', '').replaceAll(',', '');

                if (parseFloat(currentBalance) === 0) {
                    Swal.fire({
                        title: 'Error!',
                        text: 'Your wallet is empty. Please top up.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                $('#withdrawAmount').html('');

                var options = [
                    { value: 2000000, text: '2,000,000 VND' },
                    { value: 5000000, text: '5,000,000 VND' },
                    { value: 10000000, text: '10,000,000 VND' },
                    { value: currentBalance, text: 'All balance'}
                ];

                options.forEach(function(option) {
                    $('#withdrawAmount').append('<option value="' + option.value + '">' + option.text + '</option>');
                });

                $('#withdrawModal').modal('show');

                $('#withdrawModalPara').text('Your current balance is ' + parseFloat(currentBalance).toLocaleString() + ' VND. Please select the amount to withdraw from your wallet');

            });

        });
    </script>


    </body>
</th:block>
</html>
