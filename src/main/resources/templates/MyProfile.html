<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}"
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile</title>
    <link href="/css/myprofile.css" rel="stylesheet">
    <link rel="stylesheet" href="/webjars/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/webjars/select2/dist/css/select2.min.css">
    <link rel="stylesheet" href="/webjars/select2-bootstrap4-theme/dist/select2-bootstrap4.min.css"/>
    <link rel="stylesheet" href="/webjars/flatpickr/4.6.13/dist/themes/material_green.css">
    <link rel="stylesheet" href="/assets/vendor/libs/@form-validation/form-validation.css"/>

    <script src="/webjars/jquery/3.7.1/jquery.min.js"></script>
    <style>
        .alert-success {
            color: white;
            background-color: #f0f9eb;
            padding: 1px;
            margin-bottom: 20px;
            border-radius: 8px;
            /*display: flex;*/
            /*align-items: center;*/
        }

        .alert-success i {
            margin-right: 8px;
        }

        .nav {
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            padding-left: 0;
            margin-bottom: 0;
            list-style: none;
        }

        .flex-column {
            -ms-flex-direction: column !important;
            flex-direction: column !important;
        }

        .nav-pills {
            font-size: 1rem;
            font-weight: 400;
            gap: 10px;
        }

        .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
            color: #fff;
            background-color: #01d28e;
            font-weight: 500;
        }

        .nav-pills .nav-link {
            border-radius: 0.25rem;
            background: none;
            color: black;
            margin: 0;
        }

        .profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #00ff95;
            padding: 10px;
        }

        .profile img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid #00ff95;
            /*padding: 5px;*/
        }

        .changeAvatarBtn {
            cursor: pointer;
            color: #ffffff;
            width: 30px;
            height: 30px;
            background: #01d28e;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
        }

        .changeAvatarBtn:hover {
            background: #262626;
        }

        .text-muted {
            line-height: normal;
        }

        .logout-btn {
            text-align: center;
            background-color: #f0f1f3;
            color: #676767;
            border-radius: 0.25rem;
        }

        .logout-btn:hover {
            background-color: #d5d9e1 !important;
            color: #676767 !important;
        }

        :root {
            --flatpickr-color-header: #19cf91;
            --flatpickr-color-dropdown: #1e6b52;
        }

        .flatpickr-months .flatpickr-month {
            background: var(--flatpickr-color-header);
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: var(--flatpickr-color-header);
        }

        .flatpickr-weekdays {
            background: var(--flatpickr-color-header);
        }

        span.flatpickr-weekday {
            background: var(--flatpickr-color-header);
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months .flatpickr-monthDropdown-month {
            background-color: var(--flatpickr-color-dropdown);
        }

        .document {
            height: fit-content;
        }

        .document-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
            max-height: 200px;
            border: solid 2px #bfbfbf;
        }

        .select2-container--bootstrap4 .select2-selection--single {
            height: calc(2.25rem + 2px);
            line-height: 1;
            padding: 0;
        }

        .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered {
            color: #495057;
            padding: 10px;
            font-size: 0.9rem;
        }

        .select2-container--bootstrap4 .select2-results__option {
            padding: .75rem .375rem;
            font-size: 0.9rem;
        }

        .upload-license-btn {
            cursor: pointer;
            color: #ffffff;
            width: 100px;
            height: 40px;
            background: #01d28e;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
        }

        .upload-license-btn:hover {
            background: #262626;
        }

        .profile-title {
            background: #000000;
            color: white;
            border-radius: 8px;
            width: 300px;
            align-self: center;
            height: 60px;
            align-items: center;
            align-content: center;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .content-wrapper {

        }

        .modal-content {
            position: relative;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            width: 100%;
            pointer-events: auto;
            background-color: #fff;
            background-clip: padding-box;
            border: none;
            border-radius: 0.6rem;
            outline: 0;
        }

        @media (max-width: 768px) {
            .container-myProfile {
                border-radius: 0;
            }
        }

        .label-beta {
            background-color: #ffeed2;
            color: #d5961d;
            padding: 2px 15px;
            border-radius: 100px;
        }


    </style>
</head>
<th:block layout:fragment="content">

    <body>
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <!-- Modal for User description -->
    <div class="modal fade" id="descriptionModalCenter" tabindex="-1" role="dialog"
         aria-labelledby="descriptionModalCenter" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="descriptionModalCenterTitle">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container p-0">
        <div class="forgot-password-wrapper mt-md-0 mt-sm-0 p-0 p-md-5">
            <div class="container-myProfile mt-lg-7">
                <div class="row justify-content-center flex-md-row align-items-center mb-4"
                     style="flex-direction: column; gap: 10px">
                    <h2 class="profile-title m-0">My Profile</h2>
                    <span class="label-beta">Beta</span>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-3">
                        <div class="flex-column" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <div class="profile">
                                <div style="position: relative;">
                                    <img th:src="${session.user.getAvatar() != null ? '/' + session.user.getAvatar() : '/images/avt.png'}"
                                         onerror="this.src='/images/avt.png'" alt="avatar" class="avatar" id="avatarImage">
                                    <a style="position: absolute;bottom: 10px;right: 10px;">
                                        <input type="file" id="avatarInput" name="avatar" accept="image/png, image/jpeg, image/jpg"
                                               style="display: none;">
                                        <label for="avatarInput" class="changeAvatarBtn" style=""><i
                                                class="fa fa-pencil"></i></label>
                                    </a>
                                </div>
                                <div class="d-flex">
                                    <h5 class="m-0" th:text="${session.user.getUsername()}">Anonymous</h5>
                                    <a class="d-flex align-items-center" data-toggle="modal"
                                       data-target="#descriptionModalCenter">
                                        <i class="fa fa-address-card" style="padding: 0 3px; cursor: pointer"></i>
                                    </a>
                                </div>
                                <span class="text-muted"> <i class="bi bi-person-fill"></i> <span
                                        th:text="${session.user.getRoles().get(0).getRoleName()}"></span></span>
                            </div>
                            <div class="nav flex-column nav-pills mt-4 mb-4">
                                <button class="nav-link active" id="v-pills-information-tab" data-toggle="pill"
                                        data-target="#v-pills-information" type="button" role="tab"
                                        aria-controls="v-pills-information" aria-selected="true">Information
                                </button>
                                <button class="nav-link" id="v-pills-security-tab" data-toggle="pill"
                                        data-target="#v-pills-security" type="button" role="tab"
                                        aria-controls="v-pills-security" aria-selected="false">Security
                                </button>
                            </div>
                            <a class="nav-link logout-btn" id="v-pills-logout-tab" type="button" role="tab"
                               href="/logout">Logout
                            </a>
                        </div>
                    </div>
                    <div class="col-12 col-lg-9">
                        <div class="tab-content pt-4" id="v-pills-tabContent">
                            <div class="tab-pane fade show active" id="v-pills-information" role="tabpanel"
                                 aria-labelledby="v-pills-information-tab">
                                <form action="" method="post" th:object="${userInfo}" id="userFormUpdate">
                                    <input type="hidden" name="id" th:value="${userInfo.getId()}" id="userId">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <h4>Identity Information</h4>
                                    <div class="row mb-2 mt-2">
                                        <div class="form-group col-12 col-md-6">
                                            <label for="inputFullName">Full name</label>
                                            <input type="text" class="form-control" id="inputFullName" name="fullName"
                                                   aria-describedby="emailHelp" th:value="${userInfo.getFullName()}"
                                                   th:field="*{fullName}">
                                            <small id="fullNameHelp" class="form-text text-muted">Enter your full name. You can leave this field blank if you wish.</small>
                                        </div>
                                        <div class="form-group col-12 col-md-6">
                                            <div class="input">
                                                <label for="inputDob">Date of birth</label>
                                                <input type="text" class="form-control flatpickr-validation"
                                                       id="inputDob"
                                                       name="dob"
                                                       aria-describedby="dobHelp" th:value="${userInfo.getDob()}"
                                                       th:field="*{dob}">
                                            </div>
                                            <small id="dobHelp" class="form-text text-muted">Enter your date of birth in the format YYYY-MM-DD (2000-02-19). This field is optional.</small>
                                        </div>
                                        <div class="form-group col-12 col-md-6">
                                            <div class="input">
                                                <label for="inputNationalId">National ID</label>
                                                <input type="text" class="form-control" id="inputNationalId"
                                                       aria-describedby="nationalIdHelp"
                                                       maxlength="12"
                                                       minlength="9"
                                                       th:value="${userInfo.getNationalId()}"
                                                       th:field="*{nationalId}">
                                            </div>
                                            <small id="nationalIdHelp" class="form-text text-muted">Provide your National ID number (9-12 digits). You can leave this field blank.</small>
                                        </div>
                                    </div>
                                    <h4>Contact Information</h4>
                                    <div class="row mb-2 mt-2">
                                        <div class="form-group col-12 col-md-6">
                                            <label for="inputEmail">Email</label>
                                            <input type="text" class="form-control" id="inputEmail"
                                                   aria-describedby="emailHelp" th:value="${userInfo.getEmail()}"
                                                   th:field="*{email}"
                                                   disabled>
                                            <small id="emailHelp" class="form-text text-muted">Your registered email address. This field cannot be edited..</small>
                                        </div>
                                        <div class="form-group col-12 col-md-6">
                                            <div class="input">
                                                <label for="inputPhoneNumber">Phone number</label>
                                                <input type="text" class="form-control phone-number-mask"
                                                       id="inputPhoneNumber"
                                                       aria-describedby="phoneNumberHelp"
                                                       th:value="${userInfo.getPhone()}"
                                                       th:field="*{phone}">
                                            </div>
                                            <small id="phoneNumberHelp" class="form-text text-muted">Your phone number. This field is required..</small>
                                        </div>
                                    </div>
                                    <h4>Address Information</h4>
                                    <div class="row mb-2 mt-2">
                                        <div class="form-group col-12 col-md-12 col-lg-4">
                                            <label for="inputProvince">Province</label>
                                            <select class="form-control" id="inputProvince" th:field="*{city}"
                                                    th:value="${userInfo.city}"
                                                    th:data-default="${userInfo.city}">
                                                <option value="">Default select</option>
                                            </select>
                                            <small id="provinceHelp" class="form-text text-muted">Select your province from the list. This field is optional.</small>
                                        </div>
                                        <div class="form-group col-12 col-md-12 col-lg-4">
                                            <label for="inputDistrict">District</label>
                                            <select class="form-control" id="inputDistrict" th:field="*{district}"
                                                    th:value="${userInfo.district}"
                                                    th:data-default="${userInfo.district}">
                                                <option value="">Default select</option>
                                            </select>
                                            <small id="districtHelp" class="form-text text-muted">Select your district based on the chosen province. This field is optional.</small>
                                        </div>
                                        <div class="form-group col-12 col-md-12 col-lg-4">
                                            <label for="inputWard">Ward</label>
                                            <select class="form-control" id="inputWard" th:field="*{ward}"
                                                    th:value="${userInfo.ward}"
                                                    th:data-default="${userInfo.ward}">
                                                <option value="">Default select</option>
                                            </select>
                                            <small id="wardHelp" class="form-text text-muted">Choose your ward based on the selected district. This field is optional.</small>
                                        </div>
                                        <div class="form-group col-12 col-md-6">
                                            <label for="inputHome">Home</label>
                                            <input type="text" class="form-control" id="inputHome" th:field="*{street}"
                                                   th:value="${userInfo.street}"
                                                   aria-describedby="homeHelp">
                                            <small id="homeHelp" class="form-text text-muted">Enter your street and house number. You can leave this field blank.</small>
                                        </div>
                                    </div>
                                    <h4>Personal Document</h4>
                                    <div class="row mb-2 mt-2">
                                        <div class="form-group col-12 col-md-6 mb-0" style="height: fit-content">
                                            <label>Driving license</label>
                                            <div class="document mb-3" id="drivingLicenseImage">
                                                <th:block th:if="${userInfo.getDrivingLicense() != null}">
                                                    <img th:src="'/' + ${userInfo.getDrivingLicense()}"
                                                         alt="driving license"
                                                         onerror="this.style='display: none'"
                                                         class="document-image">
                                                </th:block>
                                            </div>
                                            <th:block th:if="${userInfo.getDrivingLicense() == null}">
                                                <p id="drivingLicenseMessage">No license uploaded.</p>
                                            </th:block>
                                            <a>
                                                <input type="file" id="inputDrivingLicense"
                                                       accept="image/*"
                                                       style="display: none;">
                                                <label for="inputDrivingLicense" class="upload-license-btn"
                                                       style="">Upload</label>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-center mt-5">
                                        <button type="submit" class="save-btn">Save</button>
                                        <button type="button" class="reset-btn" id="resetForm">Reset</button>
                                    </div>
                                </form>
                            </div>
                            <div class="tab-pane fade" id="v-pills-security" role="tabpanel"
                                 aria-labelledby="v-pills-security-tab">
                                <h4>Change Password</h4>
                                <form id="changePasswordForm">
                                    <div class="row mb-2 mt-2">
                                        <div class="form-group col-12 col-md-12">
                                            <div class="input">
                                                <label for="current-password">Old password</label>
                                                <input type="password" class="form-control" id="current-password"
                                                       name="currentPassword"
                                                       maxlength="32"
                                                       aria-describedby="emailHelp">
                                            </div>
                                            <small id="currentPasswordHelp" class="form-text text-muted">Enter your current password to confirm your identity.</small>
                                        </div>
                                        <div class="form-group col-12 col-md-6">
                                            <div class="input">
                                                <label for="inputNewPassword">New password</label>
                                                <input type="password" class="form-control" id="inputNewPassword"
                                                       name="newPassword"
                                                       maxlength="32"
                                                       aria-describedby="emailHelp">
                                                <div class="passwordStrength "
                                                     style="margin: 8px auto; border-radius: 2px; position: relative; margin-bottom: 20px;">
                                                    <div class="d-flex"
                                                         style="position: absolute; top: 0; left: 0; width: 100%; z-index: 11">
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%;border-right: 2px solid grey"></div>
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%;border-right: 2px solid grey"></div>
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%;border-right: 2px solid grey"></div>
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%;border-right: 2px solid grey"></div>
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%"></div>
                                                    </div>
                                                    <div id="passwordStrengthLevel"
                                                         style="height: 5px; width: 0%; background-color: #ff1c1c; position: absolute; top: 0; left: 0; z-index: 10; transition: width 0.5s">
                                                    </div>
                                                    <div class="d-flex"
                                                         style="position: absolute; top: 0; left: 0; width: 100%; z-index: 9">
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%; background-color: #c6c6c6;border-right: 2px solid grey"></div>
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%; background-color: #c6c6c6;border-right: 2px solid grey"></div>
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%; background-color: #c6c6c6;border-right: 2px solid grey"></div>
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%; background-color: #c6c6c6;border-right: 2px solid grey"></div>
                                                        <div class="cap"
                                                             style="height: 5px; width: 20%; background-color: #c6c6c6;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <small id="newPasswordHelp" class="form-text text-muted">Create a strong new password. Use uppercase, lowercase, numbers, and special characters.</small>
                                        </div>
                                        <div class="form-group col-12 col-md-6">
                                            <div class="input">
                                                <label for="inputConfirmPassword">Confirm password</label>
                                                <input type="password" class="form-control" id="inputConfirmPassword"
                                                       name="confirmPassword"
                                                       maxlength="32"
                                                       aria-describedby="emailHelp">
                                            </div>
                                            <small id="confirmPasswordHelp" class="form-text text-muted">Re-enter your new password to ensure it matches.</small>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-center mt-5">
                                        <button type="submit" class="save-btn">Change</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/webjars/select2/dist/js/select2.min.js"></script>
    <script src="/webjars/flatpickr/4.6.13/dist/flatpickr.min.js"></script>
    <script defer src="/assets/vendor/libs/@form-validation/popular.js"></script>
    <script defer src="/assets/vendor/libs/@form-validation/bootstrap5.js"></script>
    <script defer src="/assets/vendor/libs/@form-validation/auto-focus.js"></script>
    <script defer src="/assets/vendor/libs/cleavejs/cleave.js"></script>
    <script defer src="/assets/vendor/libs/cleavejs/cleave-phone.js"></script>

    <!--Page script-->
    <script src="/js/myprofile.js"></script>

    <script>
        // Fetch provinces and set default city
        async function fetchProvinces(defaultCity) {
            const response = await fetch('https://provinces.open-api.vn/api/p/');
            const provinces = await response.json();
            const citySelect = document.getElementById('inputProvince');

            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province.code;
                option.textContent = province.name;
                if (province.code == defaultCity) {
                    option.selected = true;
                }
                citySelect.appendChild(option);
            });

            if (defaultCity) {
                fetchDistricts(defaultCity, document.getElementById('inputDistrict').getAttribute('data-default'));
            }
        }

        // Fetch districts based on selected province and set default value
        async function fetchDistricts(provinceCode, defaultDistrict) {
            const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
            const provinceData = await response.json();
            const districtSelect = document.getElementById('inputDistrict');

            districtSelect.innerHTML = '<option value="">Select District</option>';
            provinceData.districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district.code;
                option.textContent = district.name;
                if (district.code == defaultDistrict) {
                    option.selected = true;
                }
                districtSelect.appendChild(option);
            });

            if (defaultDistrict) {
                fetchWards(defaultDistrict, document.getElementById('inputWard').getAttribute('data-default'));
            }
        }

        // Fetch wards based on selected district and set default value
        async function fetchWards(districtCode, defaultWard) {
            const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
            const districtData = await response.json();
            const wardSelect = document.getElementById('inputWard');

            wardSelect.innerHTML = '<option value="">Select Ward</option>';
            districtData.wards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward.code;
                option.textContent = ward.name;
                if (ward.code == defaultWard) {
                    option.selected = true;
                }
                wardSelect.appendChild(option);
            });
        }

        // Event listeners to load data on selection
        // Select 2 library
        $('#inputProvince').on('select2:select', function (e) {
            console.log("Province selected");
            const selectedProvince = $(this).val();
            fetchDistricts(selectedProvince);
            $('#inputDistrict').prop('disabled', selectedProvince === "");
        });


        // Select 2 library
        $('#inputDistrict').on('select2:select', function (e) {
            console.log("District selected");
            const selectedDistrict = $(this).val();
            fetchWards(selectedDistrict);
            $('#inputWard').prop('disabled', selectedDistrict === "");
        });

        // Load provinces on page load with default values
        document.addEventListener('DOMContentLoaded', function () {
            const defaultCity = document.getElementById('inputProvince').getAttribute('data-default');
            fetchProvinces(defaultCity);
        });
    </script>
    <script>

        // Flatpickr
        flatpickr('.flatpickr-validation', {
            // altInput: true,
            allowInput: true,
            altFormat: "F j, Y",
            dateFormat: "Y-m-d",
            maxDate: "today",
            defaultDate: new Date(),
            locale: {
                firstDayOfWeek: 1,
                weekdays: {
                    shorthand: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                    longhand: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                },
                months: {
                    shorthand: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    longhand: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                },
            },
        });


        $('#inputProvince').select2({
            placeholder: "Select a province",
            allowClear: true,
            theme: 'bootstrap4',
            fontsize: '10px',
            width: '100%'
        });
        $('#inputDistrict').select2({
            placeholder: "Select a district",
            allowClear: true,
            theme: 'bootstrap4',
            fontsize: '10px',
            width: '100%'
        });
        $('#inputWard').select2({
            placeholder: "Select a ward",
            allowClear: true,
            theme: 'bootstrap4',
            fontsize: '10px',
            width: '100%'
        });


    </script>
    </body>
</th:block>
</html>

