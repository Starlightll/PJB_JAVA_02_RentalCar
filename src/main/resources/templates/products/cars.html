<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/cars-layout}"
>
<head>
    <title>My Cars</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="_csrf" th:content="${_csrf.token}">
    <!-- Google Fonts Css-->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <!-- SlickNav Css -->
    <link href="/cars/css/slicknav.min.css" rel="stylesheet">
    <!-- Swiper Css -->
    <link rel="stylesheet" href="/cars/css/swiper-bundle.min.css">
    <!-- Animated Css -->
    <link href="/cars/css/animate.css" rel="stylesheet">
    <!-- Magnific Popup Core Css File -->
    <link rel="stylesheet" href="/cars/css/magnific-popup.css">
    <!-- Mouse Cursor Css File -->
    <link rel="stylesheet" href="/cars/css/mousecursor.css">
    <!-- Font Awesome Icon Css-->
    <link href="/cars/css/all.css" rel="stylesheet" media="screen">
    <!-- Main Custom Css -->
    <link href="/cars/css/custom.css" rel="stylesheet" media="screen">
    <!-- Flatpickr   -->
    <link rel="stylesheet" href="/webjars/flatpickr/4.6.13/dist/themes/material_green.css">
    <style>
        .hero-wrap {
            height: 200px !important;
            position: relative;
            background-image: url('/images/2024-Skoda-Enyaq-RS-Race-Concept-005-2000.jpg');
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            height: 200px !important;
        }

        .slider-text {
            height: 200px !important;
        }

        p {
            font-size: 0.8rem;
        }

        .basePrice {
            font-size: 1.4rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }

        .pickup-location-fleet {
            margin: 0 auto;
            background-color: #1b1b1b;
        }

        .pickup-location-fleet h5 {
            color: #ffffff;
            font-size: 1rem;
            font-weight: 600;
            /*text-align: center;*/
            margin: 0;
            padding: 10px 0;
        }

        .location-search {
            width: 100%;
            padding: 10px 20px;
            background: var(--white-color);
            color: var(--text-color);
            font-weight: 500;
            border: none;
            /*border-radius: 30px;*/
            box-shadow: none;
        }

        .fleets-search-box {
            border-bottom: 1px solid var(--accent-color);
        }

        .fleets-sidebar-list {
            border-bottom: 1px solid var(--accent-color);
        }


        #ftco-loader-car {
            opacity: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        #ftco-loader-car .circular {
            -webkit-animation: loader-rotate 2s linear infinite;
            animation: loader-rotate 2s linear infinite;
            position: absolute;
            left: calc(50% - 24px);
            top: calc(50% - 24px);
            display: block;
            -webkit-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        #ftco-loader-car .path {
            stroke-dasharray: 1, 200;
            stroke-dashoffset: 0;
            -webkit-animation: loader-dash 1.5s ease-in-out infinite;
            animation: loader-dash 1.5s ease-in-out infinite;
            stroke-linecap: round;
        }

        .perfect-fleet-title .available {
            color: #2c8b00;
            background-color: #e2ffde;
        }

        .perfect-fleet-title .booked {
            color: #7300ff;
            background-color: #f3edff
        }

        .perfect-fleet-title .stopped {
            color: #ff0000;
            background-color: #ffdede
        }

        .perfect-fleet-title .maintenance {
            color: #3d3d3d;
            background-color: #e4e4e4
        }

        .perfect-fleet-title .rented {
            color: #ff8c00;
            background-color: #ffedde
        }

        .perfect-fleet-title .in-progress {
            color: #00c4ff;
            background-color: #defbff
        }

        /*  Flatpickr*/

        :root {
            --flatpickr-color-header: #19cf91;
            --flatpickr-color-dropdown: #1e6b52;
        }

        .flatpickr-months .flatpickr-month {
            background: var(--flatpickr-color-header);
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: var(--flatpickr-color-header);
        }

        .flatpickr-weekdays {
            background: var(--flatpickr-color-header);
        }

        span.flatpickr-weekday {
            background: var(--flatpickr-color-header);
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months .flatpickr-monthDropdown-month {
            background-color: var(--flatpickr-color-dropdown);
        }

        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: var(--flatpickr-color-header) !important;
            -webkit-box-shadow: none;
            box-shadow: none;
            color: #fff;
            border-color: var(--flatpickr-color-header) !important;
        }

        .flatpickr-day.today {
            border-color: var(--flatpickr-color-header);
        }


    </style>
</head>

<body>
<th:block layout:fragment="content">
    <body onload="fetchCars('', '', '')">

    <section class="hero-wrap hero-wrap js-fullheight" data-stellar-background-ratio="0.5">
        <div class="overlay"></div>
        <div class="container">
            <div class="row no-gutters slider-text js-fullheight align-items-end justify-content-start">
                <div class="col-md-9 ftco-animate">
                    <p class="breadcrumbs"><span class="mr-2"><a href="/">Home <i class="ion-ios-arrow-forward"></i></a></span>
                        <span>MY CARS <i class="ion-ios-arrow-forward"></i></span></p>
                    <h1 class="mb-3 bread">My Cars!</h1>
                </div>
            </div>
        </div>
    </section>

    <!-- Page Fleets Start -->
    <div class="page-fleets">
        <div class="container" style="max-width: 1300px;">
            <div class="row">


                <div class="col-lg-3">
                    <!-- Fleets Sidebar Start -->
                    <div class="fleets-sidebar wow fadeInUp">
                        <!-- Fleets Search Box Start -->
                        <div class="fleets-search-box">
                            <form id="fleetsForm" action="#" method="POST">
                                <div class="form-group">
                                    <input type="text" name="pickupLocation" class="form-control" id="pickupLocation"
                                           placeholder="Pickup location">
                                    <button type="submit" class="section-icon-btn"><i
                                            class="fa-solid fa-magnifying-glass"></i></button>
                                </div>
                                <div>
                                    <p class="mb-0 pl-2">Pickup date time</p>
                                    <div class="form-group">
                                        <input type="text" name="pickupDateTime" id="pickupDateTime"
                                               class="form-control flatpickr-validate"
                                               placeholder="Days for rent" required>
                                    </div>
                                </div>
                                <div>
                                    <p class="mb-0 pl-2">Drop date time</p>
                                    <div class="form-group">
                                        <input type="text" name="dropDateTime" id="dropDateTime"
                                               class="form-control flatpickr-validate"
                                               placeholder="Pickup date time" required>
                                    </div>
                                </div>
                                <small id="pickupInfoHelp" style="color: rgb(255,150,0); gap: 3px"></small>
                                <!-- Fleets Sidebar List End -->
                            </form>
                        </div>
                        <!-- Fleets Search Box End -->

                        <div class="fleets-sidebar-list-box">

                            <!-- Fleets Sidebar List Start -->
                            <div class="fleets-sidebar-list">
                                <div class="fleets-list-title">
                                    <h3>Brands</h3>
                                </div>

                                <ul>
                                    <li>
                                        <p>Waiting for update</p>
                                    </li>
                                    <!--                                    <li class="form-check">-->
                                    <!--                                        <input class="form-check-input" type="checkbox" value="" id="checkbox1">-->
                                    <!--                                        <label class="form-check-label" for="checkbox1">sport cars</label>-->
                                    <!--                                    </li>-->
                                </ul>
                            </div>
                            <!-- Fleets Sidebar List End -->

                            <!-- Fleets Sidebar List Start -->
                            <div class="fleets-sidebar-list">
                                <div class="fleets-list-title">
                                    <h3>Additional Functions</h3>
                                </div>

                                <ul>
                                    <li>
                                        <p>Waiting for update</p>
                                    </li>
                                    <!--                                    <li class="form-check">-->
                                    <!--                                        <input class="form-check-input" type="checkbox" value="" id="checkbox7">-->
                                    <!--                                        <label class="form-check-label" for="checkbox7">abu dhabi</label>-->
                                    <!--                                    </li>-->

                                </ul>
                            </div>
                            <!-- Fleets Sidebar List End -->

                            <!-- Fleets Sidebar List Start -->
                            <div class="fleets-sidebar-list">
                                <div class="fleets-list-title">
                                    <h3>Price</h3>
                                </div>

                                <ul>
                                    <li>
                                        <p>Waiting for update</p>
                                    </li>
                                    <!--                                    <li class="form-check">-->
                                    <!--                                        <input class="form-check-input" type="checkbox" value="" id="checkbox11">-->
                                    <!--                                        <label class="form-check-label" for="checkbox11">abu dhabi</label>-->
                                    <!--                                    </li>-->
                                </ul>
                            </div>
                            <!-- Fleets Sidebar List End -->
                        </div>
                    </div>
                    <!-- Fleets Sidebar End -->
                </div>

                <div class="col-lg-9">
                    <!-- Fleets Collection Box Start -->
                    <div class="fleets-collection-box">
                        <div class="row" id="carContainer">

                        </div>
                        <!-- loader -->
                        <div id="ftco-loader-car" class="show fullscreen">
                            <svg class="circular" width="48px" height="48px">
                                <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4"
                                        stroke="#eeeeee"/>
                                <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4"
                                        stroke-miterlimit="10"
                                        stroke="#03ffa2"/>
                            </svg>
                        </div>
                    </div>
                    <!-- Fleets Collection Box End -->
                </div>
            </div>
        </div>
    </div>
    <!-- Page Fleets End -->

    <!-- loader -->
    <div id="ftco-loader" class="show fullscreen">
        <svg class="circular" width="48px" height="48px">
            <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/>
            <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10"
                    stroke="#03ffa2"/>
        </svg>
    </div>

    <!-- Jquery Library File -->
    <script src="/cars/js/jquery-3.7.1.min.js"></script>
    <!-- Jquery Ui Js File -->
    <script src="/cars/js/jquery-ui.js"></script>
    <!-- Bootstrap js file -->
    <script src="/cars/js/bootstrap.min.js"></script>
    <!-- Validator js file -->
    <script src="/cars/js/validator.min.js"></script>
    <!-- SlickNav js file -->
    <script src="/cars/js/jquery.slicknav.js"></script>
    <!-- Swiper js file -->
    <script src="/cars/js/swiper-bundle.min.js"></script>
    <!-- Counter js file -->
    <script src="/cars/js/jquery.waypoints.min.js"></script>
    <script src="/cars/js/jquery.counterup.min.js"></script>
    <!-- Magnific js file -->
    <script src="/cars/js/jquery.magnific-popup.min.js"></script>
    <!-- SmoothScroll -->
    <script src="/cars/js/SmoothScroll.js"></script>
    <!-- Parallax js -->
    <script src="/cars/js/parallaxie.js"></script>
    <!-- MagicCursor js file -->
    <script src="/cars/js/gsap.min.js"></script>
    <script src="/cars/js/magiccursor.js"></script>
    <!-- Text Effect js file -->
    <script src="/cars/js/SplitText.js"></script>
    <script src="/cars/js/ScrollTrigger.min.js"></script>
    <!-- YTPlayer js File -->
    <script src="/cars/js/jquery.mb.YTPlayer.min.js"></script>
    <!-- Wow js file -->
    <script src="/cars/js/wow.js"></script>
    <!-- Main Custom js file -->
    <script src="/cars/js/function.js"></script>
    <!-- Flatpickr -->
    <script src="/webjars/flatpickr/4.6.13/dist/flatpickr.min.js"></script>
    <script defer>

        // Initialize pickup datetime picker
        const pickupDatePicker = flatpickr('#pickupDateTime', {
            allowInput: false,
            minDate: "today",
            enableTime: true,
            minTime: "05:00",
            maxTime: "23:00",
            minuteIncrement: 30,
            time_24hr: true,
            defaultDate: getDefaultDateForPickup(),
            onOpen: function (selectedDates, dateStr, instance) {
                adjustMinTimeForPickupDate(selectedDates, dateStr, instance);
                // Prevent typing in hour and minute fields
                const hourInput = instance.timeContainer.querySelector('.flatpickr-hour');
                const minuteInput = instance.timeContainer.querySelector('.flatpickr-minute');
                hourInput.setAttribute('readonly', 'readonly');
                minuteInput.setAttribute('readonly', 'readonly');
            },
            onChange: function (selectedDates, dateStr, instance) {
                adjustMinTimeForDropDate(true);
            }
        });

        // Initialize drop datetime picker
        const dropDatePicker = flatpickr('#dropDateTime', {
            allowInput: false,
            minDate: "today",
            enableTime: true,
            minTime: "05:00",
            maxTime: "23:00",
            minuteIncrement: 30,
            time_24hr: true,
            defaultDate: getDefaultDateForDrop(),
            onOpen: function (selectedDates, dateStr, instance) {
                adjustMinTimeForDropDate();
                // Prevent typing in hour and minute fields
                const hourInput = instance.timeContainer.querySelector('.flatpickr-hour');
                const minuteInput = instance.timeContainer.querySelector('.flatpickr-minute');
                hourInput.setAttribute('readonly', 'readonly');
                minuteInput.setAttribute('readonly', 'readonly');
            },
            onChange: function (selectedDates, dateStr, instance) {
                adjustMinTimeForDropDate();
            }
        });


        function adjustMinTimeForPickupDate(selectedDates, dateStr, instance) {
            let now = new Date();
            if(now.getHours() < 5){
                instance.set("minTime", "05:00");
                now.setHours(5, 0, 0, 0);
                instance.set("minDate", now);
                // instance.setDate(now);
            }else{
                now.setTime(now.getTime() + 60 * 60 * 1000);
                if(now.getHours() >= 23){
                    let tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(5, 0, 0, 0);
                    console.log("New time test:", tomorrow);
                    instance.set("minTime", "05:00");
                    instance.set("minDate", tomorrow);
                    instance.setDate(tomorrow);
                }else{
                    let minTime = "";
                    if(now.getMinutes() < 30){
                        now.setHours(now.getHours());
                        now.setMinutes(0);
                        minTime = `${now.getHours().toString().padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
                        console.log(minTime)
                        instance.set("minTime", `${minTime}`);
                        instance.set("minDate", now);
                        // instance.setDate(now);
                    }
                    if(now.getMinutes() >= 30){
                        now.setHours(now.getHours());
                        now.setMinutes(30);
                        minTime = `${now.getHours().toString().padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
                        console.log(minTime)
                        instance.set("minTime", `${minTime}`);
                        instance.set("minDate", now);
                        // instance.setDate(now);
                    }
                }
            }
        }

        function getDefaultDateForPickup() {
            let now = new Date();
            let currentTime = now.getHours() + ":" + now.getMinutes();
            let currentHour = now.getHours();
            let currentMinute = now.getMinutes();
            if(now.getHours() < 5){
                now.setHours(5, 0, 0, 0);
                return now;
            }else{
                now.setTime(now.getTime() + 60 * 60 * 1000);
                if(now.getHours() >= 23){
                    let tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(5, 0, 0, 0);
                    console.log("New time test:", tomorrow);
                    return tomorrow;
                }else{
                    if(now.getMinutes() < 30){
                        now.setHours(now.getHours());
                        now.setMinutes(0);
                        return now;
                    }
                    if(now.getMinutes() >= 30){
                        now.setHours(now.getHours());
                        now.setMinutes(30);
                        return now;
                    }
                }
            }
            console.log(currentTime);
        }


        function adjustMinTimeForDropDate(haveToSet = false) {
            const pickupDateTime = document.querySelector('#pickupDateTime').value;
            const dropDateTime = document.querySelector('#dropDateTime').value;
            const oldDropDate = new Date(dropDateTime);
            const pickupDate = new Date(pickupDateTime);
            pickupDate.setTime(pickupDate.getTime() + 2 * 60 * 60 * 1000);
            const dropDate = new Date(pickupDate);
            console.log("Time for drop:", dropDate);
            if(dropDate.getHours() < 5){
                dropDate.setHours(5, 0, 0, 0);
                dropDatePicker.set("minTime", "05:00");
                dropDatePicker.set("minDate", dropDate);
                console.log(" h < 5");
                console.log(dropDate.getDate() + "-" + pickupDate.getDate() + "=" + (dropDate.getDate() - pickupDate.getDate()));
                if(oldDropDate.getDate() - pickupDate.getDate() < 1 && haveToSet === true && oldDropDate.getTime() - pickupDate.getTime() < 2 * 60 * 60 * 1000){
                    console.log("dropDate < pickupDate");
                    dropDatePicker.setDate(dropDate);
                }
                // dropDatePicker.setDate(dropDate);
            }else{
                if(dropDate.getHours() >= 23){
                    let tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(5, 0, 0, 0);
                    dropDatePicker.set("minTime", "05:00");
                    dropDatePicker.set("minDate", tomorrow);
                    console.log(" h >= 23");
                    console.log(tomorrow.getDate() + "-" + pickupDate.getDate() + "=" + (tomorrow.getDate() - pickupDate.getDate()));
                    if(oldDropDate.getDate() - pickupDate.getDate() < 1 && haveToSet === true && oldDropDate.getTime() - pickupDate.getTime() < 2 * 60 * 60 * 1000){
                        dropDatePicker.setDate(tomorrow);
                    }
                    // dropDatePicker.setDate(tomorrow);
                }else{
                    let minTime = "";
                    console.log(" h < 23 và h >= 5");
                    if(dropDate.getMinutes() < 30){
                        dropDate.setHours(dropDate.getHours());
                        dropDate.setMinutes(0);
                        minTime = `${dropDate.getHours().toString().padStart(2, "0")}:${dropDate.getMinutes().toString().padStart(2, "0")}`;
                        console.log(minTime)
                        dropDatePicker.set("minTime", `${minTime}`);
                        dropDatePicker.set("minDate", dropDate);
                        console.log(dropDate.getDate() + "-" + pickupDate.getDate() + "=" + (dropDate.getDate() - pickupDate.getDate()));
                        if(oldDropDate.getDate() - pickupDate.getDate() < 1 && haveToSet === true && oldDropDate.getTime() - pickupDate.getTime() < 2 * 60 * 60 * 1000){
                            dropDatePicker.setDate(dropDate);
                        }
                        // dropDatePicker.setDate(dropDate);
                    }
                    if(dropDate.getMinutes() >= 30){
                        dropDate.setHours(dropDate.getHours());
                        dropDate.setMinutes(30);
                        minTime = `${dropDate.getHours().toString().padStart(2, "0")}:${dropDate.getMinutes().toString().padStart(2, "0")}`;
                        console.log(minTime)
                        dropDatePicker.set("minTime", `${minTime}`);
                        dropDatePicker.set("minDate", dropDate);
                        console.log(dropDate.getDate() + "-" + pickupDate.getDate() + "=" + (dropDate.getDate() - pickupDate.getDate()));
                        if(oldDropDate.getDate() - pickupDate.getDate() < 1 && haveToSet === true && oldDropDate.getTime() - pickupDate.getTime() < 2 * 60 * 60 * 1000){
                            dropDatePicker.setDate(dropDate);
                        }
                        // dropDatePicker.setDate(dropDate);
                    }
                }
            }
            if(oldDropDate.getDate() - pickupDate.getDate() >= 1){
                dropDatePicker.set("minTime", "05:00");
            }
        }



        function getDefaultDateTime(timePlus) {
            const now = new Date();
            const currentHour = now.getHours();
            if (!timePlus) {
                timePlus = 0;
            }

            if (currentHour < 5) {
                // If it's before 5 AM, set to 5 AM today
                const defaultDate = new Date(now);
                defaultDate.setHours(5 + timePlus, 0, 0, 0);
                return defaultDate;
            } else {
                // Set to current time + 1 hour
                const defaultDate = new Date(now);
                defaultDate.setHours(currentHour + 1 + timePlus, 0, 0, 0);

                // If the calculated time would be after 21:00, set to 21:00
                if (defaultDate.getHours() > 21) {
                        defaultDate.setDate(defaultDate.getDate() + 1);
                        defaultDate.setHours(5, 0, 0, 0);
                }
                return defaultDate;
            }
        }



        function getDefaultDateForDrop() {
            const pickupDateTime = document.querySelector('#pickupDateTime').value;
            const dropDateTime = document.querySelector('#dropDateTime').value;
            const oldDropDate = new Date(dropDateTime);
            const pickupDate = new Date(pickupDateTime);
            pickupDate.setTime(pickupDate.getTime() + 2 * 60 * 60 * 1000);
            const dropDate = new Date(pickupDate);
            console.log("Time for drop:", dropDate);
            if(dropDate.getHours() < 5){
                dropDate.setHours(5, 0, 0, 0);
                return dropDate;
            }else{
                if(dropDate.getHours() >= 23){
                    let tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(5, 0, 0, 0);
                    return tomorrow;
                }else{
                    console.log(" h < 23 và h >= 5");
                    if(dropDate.getMinutes() < 30){
                        dropDate.setHours(dropDate.getHours());
                        dropDate.setMinutes(0);
                        return dropDate;
                    }
                    if(dropDate.getMinutes() >= 30){
                        dropDate.setHours(dropDate.getHours());
                        dropDate.setMinutes(30);
                        return dropDate;
                    }
                }
            }
        }

        const dropDateTime = document.querySelector('#dropDateTime');
        dropDateTime.addEventListener('change', adjustMinRentTime);

        function adjustMinRentTime() {
            const pickupInfoHelp = document.getElementById('pickupInfoHelp');
            const pickupDateTime = document.querySelector('#pickupDateTime').value;
            const dropDateTime = document.querySelector('#dropDateTime').value;

            if (!pickupDateTime || !dropDateTime) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Please select both pickup and drop times</span>';
                return false;
            }

            const pickupDate = new Date(pickupDateTime);
            const dropDate = new Date(dropDateTime);

            if (isNaN(pickupDate.getTime()) || isNaN(dropDate.getTime())) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Invalid date or time selected</span>';
                return false;
            }

            const diffHours = (dropDate - pickupDate) / 1000 / 60 / 60;

            if (diffHours < 2) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Minimum rent time is 2 hours</span>';
                return false;
            }

            pickupInfoHelp.textContent = '';
        }

        function validateTimeInput() {
            const pickupInfoHelp = document.getElementById('pickupInfoHelp');
            const pickupDateTime = document.getElementById('pickupDateTime').value;
            const dropDateTime = document.getElementById('dropDateTime').value;
            const pickupDate = new Date(pickupDateTime);
            const dropDate = new Date(dropDateTime);
            if (pickupDateTime === '' || dropDateTime === '') {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Please select both pickup and drop times</span>';
                return false;
            }
            if (isNaN(pickupDate.getTime()) || isNaN(dropDate.getTime())) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Invalid date or time selected</span>';
                return false;
            }
            if(pickupDate < new Date()) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Pickup time must be in the future</span>';
                return false;
            }
            if(dropDate < new Date()) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Drop time must be in the future</span>';
                return false;
            }
            if(pickupDate > dropDate) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Drop time must be after pickup time</span>';
                return false;
            }
            //Check if pickupDate or dropDate is not in range of 5:00 - 21:00
            if (pickupDate.getHours() < 5 || pickupDate.getHours() > 21) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Pickup time must be in range of 5:00 - 21:00</span>';
                return false;
            }
            if (dropDate.getHours() < 5 || dropDate.getHours() > 21) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Drop time must be in range of 5:00 - 21:00</span>';
                return false;
            }
            const diffHours = (dropDate - pickupDate) / 1000 / 60 / 60;
            if (diffHours < 2) {
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Minimum rent time is 2 hours</span>';
                return false;
            }


            return adjustMinRentTime() !== false;

        }

    </script>
    <script>
        function fetchCars(pickupLocation, pickupDateTime, dropDateTime) {
            const loader = document.getElementById("ftco-loader-car");
            const carContainer = document.getElementById("carContainer");

            loader.style.opacity = '1';
            carContainer.innerHTML = "";

            fetch(`/api/searchCar?pickupLocation=${pickupLocation}&pickupDateTime=${pickupDateTime}&dropDateTime=${dropDateTime}`)
                .then(response => response.json())
                .then(data => {
                    loader.style.opacity = '0';
                    if (data.length === 0) {
                        carContainer.innerHTML = '<div style="margin: auto"><h3 data-cursor="-opaque" style="color: grey">There\'re no cars that are available for you!</h3></div>';
                        return;
                    }
                    data.forEach(car => {
                        // Determine status style based on statusId
                        let statusStyle = '';
                        switch (car.carStatus.statusId) {
                            case 1:
                                statusStyle = 'color: #2c8b00; background-color: #e2ffde';
                                break;
                            case 2:
                                statusStyle = 'color: #7300ff; background-color: #f3edff';
                                break;
                            case 3:
                                statusStyle = 'color: #ff0000; background-color: #ffdede';
                                break;
                            case 5:
                                statusStyle = 'color: #3d3d3d; background-color: #e4e4e4';
                                break;
                            case 6:
                                statusStyle = 'color: #ff8c00; background-color: #ffedde';
                                break;
                            case 10:
                                statusStyle = 'color: #00c4ff; background-color: #defbff';
                                break;
                        }

                        carContainer.innerHTML += `
                        <div class="col-lg-4 col-md-6">
                            <div class="perfect-fleet-item fleets-collection-item wow fadeInUp" style="display: flex; flex-direction: column">
                                <div class="image-box" style="border-radius: 15px; overflow: hidden; height: 200px; align-content: center;">
                                    <img src="${car.frontImage}"
                                     style="width: 100%; max-width: none !important; border-radius: 14px; object-fit: cover; height: 100%;"
                                     alt="">
                                </div>

                            <div class="perfect-fleet-content">
                                <div class="perfect-fleet-title">
                                    <div style="display: flex;justify-content: space-between;flex-flow: wrap;"><h3 style="${statusStyle}">${car.carStatus.name}</h3><span style="color: #ffb825"><i class="fa fa-star" style="margin-right: 3px"></i>${car.rateAverage}</span></div>
                                    <h2>${car.carName}</h2>
                                    <div class="mt-3 d-flex ">
                                     <i class="fa fa-location-arrow mr-1" style="margin-top: 5px;"></i>
                                     <span style="font-size: 0.9rem">${car.address.province}, ${car.address.district}</span>
                                    </div>
                                </div>

                                <div class="perfect-fleet-body">
                                    <ul>
                                        <li>
                                            <i class="fa fa-user"></i>
                                            <p class="m-0">${car.seat} passenger</p>
                                        </li>
                                        <li>
                                            <i class="fa fa-sliders"></i>
                                            <p class="m-0">${car.transmission}</p>
                                        </li>
                                        <li>
                                            <i class="fa fa-gas-pump"></i>
                                            <p class="m-0">${car.fuelType}</p>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="perfect-fleet-footer">
                                <div class="perfect-fleet-pricing d-flex">
                                    <h2 data-cursor="-opaque"
                                        class="basePrice"
                                        title="${new Intl.NumberFormat().format(car.basePrice)}"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top">
                                        ${car.basePrice}
                                    </h2>
                                    <span style="font-size: 14px;font-weight: 400; align-self: center">/day</span>
                                </div>

                                    <div class="perfect-fleet-btn">
                                        <a href="#" class="section-icon-btn" onclick="viewCarDetail(${car.carId})">
                                            <img src="images/arrow-white.svg" alt="">
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                    formatMoney();
                })
                .catch(error => {
                    console.error("Error fetching cars:", error);
                    loader.style.opacity = '0';
                    carContainer.innerHTML = "<h1>Error loading cars!</h1>";
                });
        }

        function formatMoney() {
            const priceElements = document.querySelectorAll('.basePrice');

            priceElements.forEach(priceElement => {
                const price = parseFloat(priceElement.textContent);
                priceElement.textContent = new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(price);
            });
        }

        document.getElementById('fleetsForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const pickupLocation = document.getElementById('pickupLocation').value;
            const pickupDateTime = document.getElementById('pickupDateTime').value;
            const dropDateTime = document.getElementById('dropDateTime').value;

            if(pickupDateTime === '' || dropDateTime === '') {
                const pickupInfoHelp = document.getElementById('pickupInfoHelp');
                pickupInfoHelp.innerHTML = '<i class="fa fa-warning"></i><span> Please select both pickup and drop times</span>';
                return;
            }
            if(validateTimeInput() === false) {
                return;
            }
            console.log(pickupLocation, pickupDateTime, dropDateTime);
            fetchCars(pickupLocation, pickupDateTime, dropDateTime);
        });

        function viewCarDetail(carId) {
            const pickupLocation = document.getElementById('pickupLocation').value;
            const pickupDateTime = document.getElementById('pickupDateTime').value;
            const dropDateTime = document.getElementById('dropDateTime').value;
            window.location.href = `/api/searchCar/${carId}?pickupLocation=${pickupLocation}&pickupDateTime=${pickupDateTime}&dropDateTime=${dropDateTime}`;
        }


    </script>
    </body>
</th:block>
</body>
</html>
